app.controller("RouteEditController",function($rootScope,$scope,$http,$state,$localStorage,$stateParams,$filter,$myHttpService){function closeEditMode(index){for(var i=0,len=$scope.buslineStations.length;len>i;i++)i!=index&&($scope.buslineStations[i].editMode=!1)}$scope.editMode=!!$stateParams.id;var $sortable=$("#J_sortable").sortable();$scope.editMode?($scope.buslineStations=[],$myHttpService.post("api/busline/queryBusline.htm",{lineid:$stateParams.id},function(data){$scope.busline=data.busline;for(var stations=data.stations,i=0;i<stations.length;i++)$scope.buslineStations.push({lineid:stations[i].lineid,stationId:stations[i].stationid,stationName:stations[i].stationname,lng:stations[i].stalongitude,lat:stations[i].stalatitude,drivingTime:stations[i].drivingtime});window.setTimeout(function(){$scope.$apply(),$sortable.sortable()}),MapOperation.addMarkers($scope.buslineStations)})):($scope.busline={lineid:"",linename:"",runstatus:0,linetype:0,region:"武汉市",stationnum:0},$scope.buslineStations=[]),$scope.tabs=[!0,!1],$scope.tab=function(index){for(var i=0,len=$scope.tabs.length;len>i;i++)$scope.tabs[i]=i!=index?!1:!0},$scope.changeRunStatus=function(){$scope.busline.runstatus=0==$scope.busline.runstatus?1:0};var MapOperation={map:null,contextMenuPositon:null,contextMenu:null,createMap:function(){MapOperation.map=new AMap.Map("J_map_canvas",{zooms:[1,18],zoom:12,center:[114.399249386,30.5040608762]}),MapOperation.contextMenu=new AMap.ContextMenu,MapOperation.contextMenu.addItem("添加站点",function(){var len=$scope.buslineStations.length;closeEditMode(9999);var busline={stationId:(new Date).getTime()+""+(Math.floor(9e3*Math.random())+1e3),stationName:"新建站点  "+len,lng:MapOperation.contextMenuPositon.getLng(),lat:MapOperation.contextMenuPositon.getLat(),drivingTime:0,editMode:!0};len>1?$scope.buslineStations.splice(len-1,0,busline):$scope.buslineStations.push(busline),MapOperation.addMarkers([busline]),$scope.$apply(),$sortable.sortable(),MapOperation.calcRouteLine()},0),MapOperation.contextMenu.addItem("放大一级",function(){MapOperation.map.zoomIn()},1),MapOperation.contextMenu.addItem("缩小一级",function(){MapOperation.map.zoomOut()},2),MapOperation.map.on("rightclick",function(e){MapOperation.contextMenu.open(MapOperation.map,e.lnglat),MapOperation.contextMenuPositon=e.lnglat})},addMarkers:function(buslines){for(var i=0,len=buslines.length;len>i;i++){var text="<div class='marker station-marker'>"+i+"</div>";0==i?text="<div class='marker start-marker'>起</div>":i==len-1&&(text="<div class='marker stop-marker'>终</div>");var marker=new AMap.Marker({map:MapOperation.map,position:new AMap.LngLat(buslines[i].lng,buslines[i].lat),content:text,extData:buslines[i],draggable:!0});AMap.event.addListener(marker,"dragend",function(){for(var j=0,len2=$scope.buslineStations.length;len2>j;j++){var data=this.getExtData(),lngLat=this.getPosition();if(data.stationId==$scope.buslineStations[j].stationId){closeEditMode(9999),$scope.buslineStations[j].lng=lngLat.getLng(),$scope.buslineStations[j].lat=lngLat.getLat(),$scope.buslineStations[j].editMode=!0,$scope.$apply();break}}})}},calcRouteLine:function(){MapOperation.map.clearMap(),MapOperation.addMarkers($scope.buslineStations)}};$scope.location=function(data){MapOperation.map.setCenter(new AMap.LngLat(data.lng,data.lat))},$sortable.on("sortupdate",function(){var temp=[];$sortable.children("li").each(function(index,item){temp.push(JSON.parse($(item).attr("data")))}),$scope.buslineStations=temp,$scope.$apply(),$sortable.sortable(),MapOperation.calcRouteLine()}),MapOperation.createMap(),$scope.edit=function(index){closeEditMode(index),$scope.buslineStations[index].editMode=!$scope.buslineStations[index].editMode},$scope.delete=function(index){$scope.buslineStations.splice(index,1),$sortable.sortable(),MapOperation.calcRouteLine()},$scope.save=function(){$scope.submit(!0)},$scope.submit=function(saveMode){var len=$scope.buslineStations.length;if(len>1){for(var stations=[],i=0;len>i;i++)stations.push({stationid:$scope.buslineStations[i].stationId,lineid:$scope.buslineStations[i].lineid,stationname:$scope.buslineStations[i].stationName,stalongitude:$scope.buslineStations[i].lng,stalatitude:$scope.buslineStations[i].lat,drivingtime:$scope.buslineStations[i].drivingTime,serialno:i});$scope.busline.stationnum=len,$scope.busline.departaddr=stations[0].stationname,$scope.busline.departlon=stations[0].stalongitude,$scope.busline.departlat=stations[0].stalatitude,$scope.busline.arriveaddr=stations[len-1].stationname,$scope.busline.arrivelon=stations[len-1].stalongitude,$scope.busline.arrivelat=stations[len-1].stalatitude;var data={busline:$scope.busline,stations:stations};$scope.editMode&&!saveMode?$myHttpService.post("api/busline/updateBuslineInfo.htm",{data:JSON.stringify(data)},function(){layer.msg("修改成功！",{offset:"100px"})}):$myHttpService.post("api/busline/insertBusline.htm",{data:JSON.stringify(data)},function(){layer.msg("添加成功！",{offset:"100px"}),$state.go("layout.route_add",{},{reload:!0})})}else layer.alert("一条线路必须有一个起点和终点")}}),app.controller("RouteListController",function($rootScope,$scope,$http,$state,$localStorage,$stateParams,$filter,$tableListService,$myHttpService){var selected=!1;$scope.selectAll=function(){selected=!selected,angular.forEach($scope.pageResponse.buslines,function(item){item.selected=selected})};var options={searchFormId:"J_search_form",listUrl:"api/busline/queryBuslineByKeyword.htm"};$scope.delete=function(item){layer.confirm("您确定要删除吗？",{icon:3,title:"提示"},function(){$myHttpService.post("api/busline/deleteBusline.htm",item,function(){layer.msg("删除成功！",{offset:"100px"}),$state.go("app.route.list",{},{reload:!0})})},function(index){layer.close(index)})},$tableListService.init($scope,options),$tableListService.get()}),app.controller("RouteCreateListController",function($rootScope,$scope,$http,$state,$localStorage,$stateParams,$filter,$tableListService){var selected=!1;$scope.selectAll=function(){selected=!selected,angular.forEach($scope.pageResponse.buslines,function(item){item.selected=selected})};var options={searchFormId:"J_search_form",listUrl:"api/busline/queryApplyBuslinesByKeyword.htm"};$tableListService.init($scope,options),$tableListService.get()});