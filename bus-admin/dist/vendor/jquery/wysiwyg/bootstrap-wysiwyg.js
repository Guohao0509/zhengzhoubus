!function($){"use strict";var readFileIntoDataUrl=function(fileInfo){var loader=$.Deferred(),fReader=new FileReader;return fReader.onload=function(e){loader.resolve(e.target.result)},fReader.onerror=loader.reject,fReader.onprogress=loader.notify,fReader.readAsDataURL(fileInfo),loader.promise()};$.fn.cleanHtml=function(){var html=$(this).html();return html&&html.replace(/(<br>|\s|<div><br><\/div>|&nbsp;)*$/,"")},$.fn.wysiwyg=function(userOptions){var selectedRange,options,toolbarBtnSelector,editor=this,updateToolbar=function(){options.activeToolbarClass&&$(options.toolbarSelector).find(toolbarBtnSelector).each(function(){var command=$(this).data(options.commandRole);document.queryCommandState(command)?$(this).addClass(options.activeToolbarClass):$(this).removeClass(options.activeToolbarClass)})},execCommand=function(commandWithArgs,valueArg){var commandArr=commandWithArgs.split(" "),command=commandArr.shift(),args=commandArr.join(" ")+(valueArg||"");document.execCommand(command,0,args),updateToolbar()},bindHotkeys=function(hotKeys){$.each(hotKeys,function(hotkey,command){editor.keydown(hotkey,function(e){editor.attr("contenteditable")&&editor.is(":visible")&&(e.preventDefault(),e.stopPropagation(),execCommand(command))}).keyup(hotkey,function(e){editor.attr("contenteditable")&&editor.is(":visible")&&(e.preventDefault(),e.stopPropagation())})})},getCurrentRange=function(){var sel=window.getSelection();return sel.getRangeAt&&sel.rangeCount?sel.getRangeAt(0):void 0},saveSelection=function(){selectedRange=getCurrentRange()},restoreSelection=function(){var selection=window.getSelection();if(selectedRange){try{selection.removeAllRanges()}catch(ex){document.body.createTextRange().select(),document.selection.empty()}selection.addRange(selectedRange)}},insertFiles=function(files){editor.focus(),$.each(files,function(idx,fileInfo){/^image\//.test(fileInfo.type)?$.when(readFileIntoDataUrl(fileInfo)).done(function(dataUrl){execCommand("insertimage",dataUrl)}).fail(function(e){options.fileUploadError("file-reader",e)}):options.fileUploadError("unsupported-file-type",fileInfo.type)})},markSelection=function(input,color){restoreSelection(),document.queryCommandSupported("hiliteColor")&&document.execCommand("hiliteColor",0,color||"transparent"),saveSelection(),input.data(options.selectionMarker,color)},bindToolbar=function(toolbar,options){toolbar.find(toolbarBtnSelector).click(function(){restoreSelection(),editor.focus(),execCommand($(this).data(options.commandRole)),saveSelection()}),toolbar.find("[data-toggle=dropdown]").click(restoreSelection),toolbar.find("input[type=text][data-"+options.commandRole+"]").on("webkitspeechchange change",function(){var newValue=this.value;this.value="",restoreSelection(),newValue&&(editor.focus(),execCommand($(this).data(options.commandRole),newValue)),saveSelection()}).on("focus",function(){var input=$(this);input.data(options.selectionMarker)||(markSelection(input,options.selectionColor),input.focus())}).on("blur",function(){var input=$(this);input.data(options.selectionMarker)&&markSelection(input,!1)}),toolbar.find("input[type=file][data-"+options.commandRole+"]").change(function(){restoreSelection(),"file"===this.type&&this.files&&this.files.length>0&&insertFiles(this.files),saveSelection(),this.value=""})},initFileDrops=function(){editor.on("dragenter dragover",!1).on("drop",function(e){var dataTransfer=e.originalEvent.dataTransfer;e.stopPropagation(),e.preventDefault(),dataTransfer&&dataTransfer.files&&dataTransfer.files.length>0&&insertFiles(dataTransfer.files)})};return options=$.extend({},$.fn.wysiwyg.defaults,userOptions),toolbarBtnSelector="a[data-"+options.commandRole+"],button[data-"+options.commandRole+"],input[type=button][data-"+options.commandRole+"]",bindHotkeys(options.hotKeys),options.dragAndDropImages&&initFileDrops(),bindToolbar($(options.toolbarSelector),options),editor.attr("contenteditable",!0).on("mouseup keyup mouseout",function(){saveSelection(),updateToolbar()}),$(window).bind("touchend",function(e){var isInside=editor.is(e.target)||editor.has(e.target).length>0,currentRange=getCurrentRange(),clear=currentRange&&currentRange.startContainer===currentRange.endContainer&&currentRange.startOffset===currentRange.endOffset;(!clear||isInside)&&(saveSelection(),updateToolbar())}),this},$.fn.wysiwyg.defaults={hotKeys:{"ctrl+b meta+b":"bold","ctrl+i meta+i":"italic","ctrl+u meta+u":"underline","ctrl+z meta+z":"undo","ctrl+y meta+y meta+shift+z":"redo","ctrl+l meta+l":"justifyleft","ctrl+r meta+r":"justifyright","ctrl+e meta+e":"justifycenter","ctrl+j meta+j":"justifyfull","shift+tab":"outdent",tab:"indent"},toolbarSelector:"[data-role=editor-toolbar]",commandRole:"edit",activeToolbarClass:"btn-info",selectionMarker:"edit-focus-marker",selectionColor:"darkgrey",dragAndDropImages:!0,fileUploadError:function(reason,detail){console.log("File upload error",reason,detail)}}}(window.jQuery);